{{/* Inputs: node, level, current */}}

{{- $node := .node -}}
{{- $level := .level -}}
{{- $current := .current -}}

{{- $id := printf "nav-%s" (replace $node.RelPermalink "/" "-" -1) -}}

{{- $isActive := eq $node.RelPermalink $current.RelPermalink -}}
{{- $childSections := $node.Sections -}}
{{- $childPages := where $node.Pages "File.BaseFileName" "ne" "_index" -}}
{{- $hasChildren := or (gt (len $childSections) 0) (gt (len $childPages) 0) -}}

{{- $isAncestor := and (not $isActive) (hasPrefix $current.RelPermalink $node.RelPermalink) -}}
{{- $shouldExpand := or $isActive $isAncestor -}}

<li class="mb-1">

  {{ if $node.IsSection }}

    <div class="d-flex align-items-center"
         style="padding-left: {{ mul $level 18 }}px; font-size: 0.95rem;">

      {{ if $hasChildren }}
        <button class="btn btn-toggle d-inline-flex align-items-center border-0 p-0 me-1
                       {{ if not $shouldExpand }}collapsed{{ end }}"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#{{ $id }}"
                aria-expanded="{{ if $shouldExpand }}true{{ else }}false{{ end }}">
        </button>
      {{ else }}
        <span class="me-3"></span>
      {{ end }}

      <a href="{{ $node.Permalink }}"
         class="d-inline-flex align-items-center text-decoration-none 
                {{ if $isActive }}active-link{{ end }}">

        <i class="bi {{ if $shouldExpand }}bi-folder2-open{{ else }}bi-folder-fill{{ end }}
              text-warning me-2"></i>

        {{ $node.Title }}
      </a>

    </div>

    {{ if $hasChildren }}
    <div class="collapse {{ if $shouldExpand }}show{{ end }}" id="{{ $id }}">
      <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
        {{ range $childSections }}
          {{ partial "sidebar-item.html" (dict "node" . "level" (add $level 1) "current" $current) }}
        {{ end }}

        {{ range $childPages }}
          {{ partial "sidebar-item.html" (dict "node" . "level" (add $level 1) "current" $current) }}
        {{ end }}
      </ul>
    </div>
    {{ end }}

  {{ else }}

    <a href="{{ $node.Permalink }}"
       class="link-dark d-inline-flex align-items-center text-decoration-none
              {{ if $isActive }}active-link{{ end }}"
       style="padding-left: {{ mul $level 22 }}px; font-size: 0.95rem;">

       <i class="bi bi-file-earmark-text text-warning me-2"></i>

       {{ if $node.Title }}
         {{ $node.Title }}
       {{ else }}
         {{ replace (replace ($node.File.BaseFileName) "-" " ") "_" " " | title }}
       {{ end }}
    </a>

  {{ end }}

</li>
