{{/* Inputs: node, level, current */}}

{{- $node := .node -}}
{{- $level := .level -}}
{{- $current := .current -}}

{{- $id := printf "nav-%s" (replace $node.RelPermalink "/" "-" -1) -}}

{{- $isActive := eq $node.RelPermalink $current.RelPermalink -}}
{{- $childSections := $node.Sections -}}
{{- $childPages := where $node.Pages "File.BaseFileName" "ne" "_index" -}}
{{- $hasChildren := or (gt (len $childSections) 0) (gt (len $childPages) 0) -}}

{{- $isAncestor := and (not $isActive) (hasPrefix $current.RelPermalink $node.RelPermalink) -}}
{{- $shouldExpand := or $isActive $isAncestor -}}

<li class="mb-1">

  {{- if $node.IsSection -}}

    <!-- SECTION BUTTON WITH CARET (Bootstrap demo style) -->
    <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0{{ if $shouldExpand }}{{ else }} collapsed{{ end }}"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#{{ $id }}"
            aria-expanded="{{ if $shouldExpand }}true{{ else }}false{{ end }}"
            style="padding-left: {{ mul $level 12 }}px;">
            <!-- FOLDER ICON (open/closed) -->
  <i class="bi {{ if $shouldExpand }}bi-folder2-open{{ else }}bi-folder-fill{{ end }} text-warning
    folder-icon me-1" data-folder-icon="{{ $id }}"></i>
      {{ $node.Title }}
    </button>

    {{- if $hasChildren -}}
      <div class="collapse {{ if $shouldExpand }}show{{ end }}" id="{{ $id }}">
        <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          {{- range $childSections -}}
            {{- partial "sidebar-item.html" (dict "node" . "level" (add $level 1) "current" $current) -}}
          {{- end -}}

          {{- range $childPages -}}
            {{- partial "sidebar-item.html" (dict "node" . "level" (add $level 1) "current" $current) -}}
          {{- end -}}
        </ul>
      </div>
    {{- end -}}

  {{- else -}}

    <!-- SIMPLE FILE LINK -->
    <a href="{{ $node.RelPermalink }}"
       class="link-dark d-inline-flex text-decoration-none rounded {{ if $isActive }}active-link{{ end }}"
       style="padding-left: {{ mul $level 12 }}px;">
       <i class="bi bi-file-earmark-text text-warning me-2"></i>
      {{ if $node.Title }}
      {{ $node.Title }}
  {{ else }}
      {{ replace (replace ($node.File.BaseFileName) "-" " ") "_" " " | title }}
  {{ end }}
    </a>

  {{- end -}}

</li>
